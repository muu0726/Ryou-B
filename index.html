<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="„Çä„Çá„ÅÜ„Åü„Çì„Éñ„É©„Çπ„Éà - Block BlastÈ¢®„Éë„Ç∫„É´„Ç≤„Éº„É†">
    <meta name="theme-color" content="#ff6b6b">

    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://www.gstatic.com https://*.firebaseio.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob:;
        connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.cloudfunctions.net;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="manifest" href="manifest.json">
    <title>„Çä„Çá„ÅÜ„Åü„Çì„Éñ„É©„Çπ„Éà</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="game-container">
        <header id="header">
            <div class="score-display">
                <span class="label">SCORE</span>
                <span id="score">0</span>
            </div>
            <div class="header-buttons">
                <button id="sound-btn" title="„Çµ„Ç¶„É≥„Éâ">üîä</button>
                <button id="header-ranking-btn" title="„É©„É≥„Ç≠„É≥„Ç∞">üèÜ</button>
                <button id="retry-btn" title="„É™„Éà„É©„Ç§">üîÑ</button>
            </div>
            <div class="score-display">
                <span class="label">BEST</span>
                <span id="high-score">0</span>
            </div>
        </header>

        <main id="main-area">
            <canvas id="game-canvas"></canvas>
        </main>

        <footer id="block-tray">
            <!-- 3„Å§„ÅÆ„Éñ„É≠„ÉÉ„ÇØÂÄôË£ú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
        </footer>

        <div id="combo-display" class="hidden">
            <span id="combo-count">0</span>
            <span class="combo-label">COMBO</span>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-overlay" class="overlay hidden">
        <div class="leaderboard-modal">
            <div class="leaderboard-header">üèÜ „É©„É≥„Ç≠„É≥„Ç∞ üèÜ</div>
            <div id="leaderboard-list" class="leaderboard-list">
                <!-- Javascript will populate this -->
                <div style="text-align:center; padding: 20px;">Loading...</div>
            </div>

            <div id="score-submit-area" class="leaderboard-input-area hidden">
                <input type="text" id="player-name-input" class="player-name-input" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="10">
                <button id="submit-score-btn" class="submit-score-btn">ÈÄÅ‰ø°</button>
            </div>
            <div style="text-align: center; margin-bottom: 10px; font-size: 0.8rem; color: #888;" id="my-score-display">
            </div>

            <button id="close-leaderboard-btn" class="close-modal-btn">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- Game Over Overlay -->
    <div id="game-over-overlay" class="overlay hidden">
        <div class="overlay-content">
            <h1>GAME OVER</h1>
            <p>SCORE: <span id="final-score">0</span></p>
            <p>BEST: <span id="final-high-score">0</span></p>
            <div class="overlay-buttons">
                <div class="game-over-buttons">
                    <button id="restart-btn" class="btn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                    <button id="show-leaderboard-btn" class="btn secondary">„É©„É≥„Ç≠„É≥„Ç∞„Å´ËøΩÂä†</button>
                </div>
                <button id="share-btn">üì§ „Ç∑„Çß„Ç¢</button>
            </div>
        </div>
    </div>

    <!-- Perfect Clear Overlay -->
    <div id="perfect-overlay" class="overlay hidden">
        <img id="perfect-image" src="" alt="Perfect!">
        <div class="perfect-text">PERFECT!</div>
    </div>

    <!-- Cache busting -->
    <script type="module" src="main.js?v=4"></script>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister(); // Force unregister to clear old cache
                }
            });

            // Re-register
            navigator.serviceWorker.register('/sw.js?v=4')
                .then(() => console.log('Service Worker registered (v3)'))
                .catch(err => console.warn('Service Worker registration failed:', err));
        }
    </script>
</body>

</html>